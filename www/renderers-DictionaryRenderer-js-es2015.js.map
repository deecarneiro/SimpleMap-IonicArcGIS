{"version":3,"sources":["./node_modules/@arcgis/core/renderers/DictionaryRenderer.js"],"names":[],"mappings":";;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACukC,MAAM,QAAQ,uDAAC,gDAAgD,sBAAsB,6FAAC,CAAC,qDAAC,GAAG,eAAe,6DAA6D,0DAAC,wIAAwI,eAAe,6BAA6B,iCAAiC,EAAE,8BAA8B,uDAAuD,QAAQ,cAAc,OAAO,2DAAC,2GAA2G,2DAAC,oBAAoB,2DAAC,2BAA2B,2DAAC,uBAAuB,EAAE,0BAA0B,MAAM,0EAA0E,IAAI,gCAAgC,SAAS,GAAG,2EAAC,6CAA6C,WAAW,oDAAoD,yBAAyB,wDAAwD,2BAA2B,OAAO,aAAa,eAAe,sCAAsC,QAAQ,mEAAC,0CAA0C,0BAA0B,yBAAyB,KAAK,kBAAkB,aAAa,kJAAkJ,uCAAuC,KAAK,+BAA+B,iBAAiB,oBAAoB,WAAW,yDAAyD,qBAAqB,YAAY,kDAAC,aAAa,4BAA4B,iBAAiB,QAAQ,uCAAuC,GAAG,yCAAyC,sCAAsC,iCAAiC,oEAAoE,8FAAC,2BAA2B,2BAA2B,oFAAoF,qBAAqB,SAAS,wBAAwB,0DAA0D,kDAAkD,QAAQ,6DAAC,0BAA0B,4DAAC,oDAAoD,2BAA2B,SAAS,MAAM,IAAI,OAAO,QAAQ,kEAAC,IAAI,8EAAC,KAAK,6CAA6C,uDAAC,6DAA6D,uCAAuC,8HAA8H,WAAW,gBAAgB,oBAAoB,2BAA2B,6EAA6E,WAAW,GAAG,6DAAC,gEAAgE,4DAA4D,oBAAoB,eAAe,EAAE,+BAA+B,8FAAC,GAAG,6DAAC,2CAA2C,SAAS,SAAS,cAAc,4BAA4B,2BAA2B,EAAE,eAAe,6DAAC,+BAA+B,mBAAmB,GAAG,kGAAkG,YAAY,YAAY,aAAa,SAAS,mBAAmB,6FAA6F,cAAc,SAAS,SAAS,GAAG,8BAA8B,EAAE,kBAAkB,0BAA0B,0BAA0B,sFAAsF,8CAA8C,UAAU,SAAS,4DAAC,IAAI,2BAA2B,SAAS,MAAM,EAAE,+BAA+B,IAAI,qBAAqB,SAAS,uCAAuC,qEAAC,KAAK,yBAAyB,gCAAgC,uBAAuB,4DAA4D,SAAS,SAAS,kBAAkB,kBAAkB,UAAU,0CAA0C,OAAO,yDAAyD,kCAAkC,4BAA4B,YAAY,WAAW,qCAAqC,cAAc,kEAAC,IAAI,WAAW,8DAAC,EAAE,mCAAmC,IAAI,8DAAC,EAAE,6FAAC,EAAE,kBAAkB,MAAM,uBAAuB,QAAQ,yBAAyB,gCAAgC,8DAAC,EAAE,6FAAC,EAAE,kBAAkB,UAAU,kCAAkC,8DAAC,EAAE,6FAAC,EAAE,kBAAkB,MAAM,0CAA0C,WAAW,yCAAyC,8DAAC,EAAE,yFAAC,mDAAmD,8DAAC,EAAE,6FAAC,EAAE,kBAAkB,MAAM,qCAAqC,QAAQ,uDAAuD,OAAO,wCAAwC,8CAA8C,8DAAC,EAAE,6FAAC,EAAE,kBAAkB,UAAU,6BAA6B,8DAAC,EAAE,yFAAC,kEAAkE,8DAAC,EAAE,6FAAC,0CAA0C,QAAuB,gEAAC,EAAC","file":"renderers-DictionaryRenderer-js-es2015.js","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.18/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../chunks/tslib.es6.js\";import\"../core/has.js\";import{clone as s}from\"../core/lang.js\";import{isSome as t}from\"../core/maybe.js\";import{numericHash as r}from\"../core/string.js\";import i from\"../core/Logger.js\";import\"../core/accessorSupport/ensureType.js\";import{property as o}from\"../core/accessorSupport/decorators/property.js\";import{subclass as n}from\"../core/accessorSupport/decorators/subclass.js\";import{writer as a}from\"../core/accessorSupport/decorators/writer.js\";import l from\"../core/Error.js\";import\"../core/urlUtils.js\";import\"../core/uuid.js\";import\"../portal/support/resourceExtension.js\";import{isAbortError as c,all as p,reject as u}from\"../core/promiseUtils.js\";import{loadArcade as m,createDictionaryExpression as f}from\"../support/arcadeOnDemand.js\";import{collectArcadeFieldNames as h}from\"../layers/support/fieldUtils.js\";import y from\"../Color.js\";import d from\"../symbols/CIMSymbol.js\";import g from\"../request.js\";import b from\"./Renderer.js\";import{VisualVariablesMixin as j}from\"./mixins/VisualVariablesMixin.js\";import _ from\"../core/LRUCache.js\";var w;const x=i.getLogger(\"esri.renderers.DictionaryRenderer\");let v=w=class extends(j(b)){constructor(e){super(e),this._ongoingRequests=new Map,this._symbolCache=new _(100),this.config=null,this.fieldMap=null,this.scaleExpression=null,this.scaleExpressionTitle=null,this.url=null,this.type=\"dictionary\"}writeData(e,s){e&&(s.scalingExpressionInfo={expression:e,returnType:\"number\"})}writeVisualVariables(e,s,t,r){null!=r&&r.origin||super.writeVisualVariables(e,s,t,r)}clone(){return new w({config:s(this.config),scaleExpression:this.scaleExpression,scaleExpressionTitle:this.scaleExpressionTitle,fieldMap:s(this.fieldMap),url:s(this.url),visualVariables:s(this.visualVariables)})}async getSymbolAsync(e,s){let t;this._dictionaryPromise||(this._dictionaryPromise=this.fetchResources(s));try{t=await this._dictionaryPromise}catch(e){if(c(e))return this._dictionaryPromise=null,null}const i={};if(this.fieldMap)for(const s of this._symbolFields){const t=this.fieldMap[s];if(t&&null!==e.attributes[t]&&void 0!==e.attributes[t]){const r=\"\"+e.attributes[t];i[s]=r}else i[s]=\"\"}const o=t(i,s);if(!o||\"string\"!=typeof o)return null;const n=r(o).toString(),a=this._symbolCache.get(n);if(a)return a.catch((()=>{this._symbolCache.pop(n)})),a;const l=o.split(\";\"),p=[],u=[];for(const e of l)if(e&&0!==e.length)if(-1===e.indexOf(\"po:\"))if(-1!==e.indexOf(\"|\"))for(const s of e.split(\"|\"))this._itemNames.has(s)&&p.push(s);else this._itemNames.has(e)&&p.push(e);else{const s=e.substr(3).split(\"|\");if(3===s.length){const e=s[0],t=s[1];let r=s[2];if(\"DashTemplate\"===t)r=r.split(\" \").map((e=>Number(e)));else if(\"Color\"===t){const e=new y(r).toRgba();r=[e[0],e[1],e[2],255*e[3]]}else r=Number(r);u.push({primitiveName:e,propertyName:t,value:r})}}const m=this._cimPartsToCIMSymbol(p,u,s);return this._symbolCache.put(n,m,1),m}async collectRequiredFields(e,s){await this.collectVVRequiredFields(e,s),this.scaleExpression&&await h(e,s,this.scaleExpression);const t=s.map((e=>e.name));for(const s in this.fieldMap)t.indexOf(this.fieldMap[s])<0||e.add(this.fieldMap[s])}get arcadeRequired(){return!0}async fetchResources(e){if(this._dictionaryPromise)return this._dictionaryPromise;if(!this.url)return void x.error(\"no valid URL!\");const s=t(e)?e.abortOptions:null,r=g(this.url+\"/resources/styles/dictionary-info.json\",{responseType:\"json\",query:{f:\"json\"},...s}),[{data:i}]=await p([r,m()]);if(!i)throw this._dictionaryPromise=null,new l(\"esri.renderers.DictionaryRenderer\",\"Bad dictionary data!\");const o=i.expression,n=i.authoringInfo;this._refSymbolUrlTemplate=this.url+\"/\"+i.cimRefTemplateUrl,this._itemNames=new Set(i.itemsNames),this._symbolFields=n.symbol;const a={};if(this.config){const e=this.config;for(const s in e)a[s]=e[s]}for(const e of n.configuration)a.hasOwnProperty(e.name)||(a[e.name]=e.value);const c=[];if(t(e)&&e.fields&&this.fieldMap)for(const s of this._symbolFields){const t=this.fieldMap[s],r=e.fields.filter((e=>e.name===t));r.length>0&&c.push({...r[0],name:s})}return this._dictionaryPromise=f(o,t(e)?e.spatialReference:null,c,a).then((e=>{const s={scale:0};return(r,i)=>{const o=e.repurposeFeature({geometry:null,attributes:r});return s.scale=t(i)?i.scale:void 0,e.evaluate({$feature:o,$view:s})}})).catch((e=>(x.error(\"Creating dictinoary expression failed:\",e),null))),this._dictionaryPromise}getSymbol(){return null}getSymbols(){return[]}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce(((e,s)=>e+s.getAttributeHash()),\"\")}getMeshHash(){return`${this.url}-${JSON.stringify(this.fieldMap)}`}getSymbolFields(){return this._symbolFields}async _getSymbolPart(e,s){if(this._ongoingRequests.has(e))return this._ongoingRequests.get(e).then((e=>e.data));const t=this._refSymbolUrlTemplate.replace(/\\{itemName\\}/gi,e),r=g(t,{responseType:\"json\",query:{f:\"json\"},...s});this._ongoingRequests.set(e,r);try{return(await r).data}catch(s){return this._ongoingRequests.delete(e),u(s)}}_combineSymbolParts(e,s){if(!e||0===e.length)return null;if(1===e.length)return{type:\"CIMSymbolReference\",symbol:e[0],primitiveOverrides:s};const t={...e[0]};t.symbolLayers=[];for(const s of e){const e=s;t.symbolLayers.unshift(...e.symbolLayers)}return{type:\"CIMSymbolReference\",symbol:t,primitiveOverrides:s}}async _cimPartsToCIMSymbol(e,s,t){const r=new Array(e.length);for(let s=0;s<e.length;s++)r[s]=this._getSymbolPart(e[s],t);const i=await p(r);return new d({data:this._combineSymbolParts(i,s)})}};e([o({type:Object,json:{read:{source:\"configuration\"},write:{target:\"configuration\"}}})],v.prototype,\"config\",void 0),e([o({type:Object,json:{write:!0}})],v.prototype,\"fieldMap\",void 0),e([o({type:String,json:{read:{source:\"scalingExpressionInfo.expression\"},write:!0}})],v.prototype,\"scaleExpression\",void 0),e([a(\"scaleExpression\")],v.prototype,\"writeData\",null),e([o({type:String,json:{read:{source:\"scalingExpressionInfo.title\"},write:{target:\"scalingExpressionInfo.title\",overridePolicy(e){return{enabled:!!e&&!!this.scaleExpression}}}}})],v.prototype,\"scaleExpressionTitle\",void 0),e([o({type:String,json:{write:!0}})],v.prototype,\"url\",void 0),e([a(\"visualVariables\")],v.prototype,\"writeVisualVariables\",null),v=w=e([n(\"esri.renderers.DictionaryRenderer\")],v);var S=v;export default S;\n"],"sourceRoot":"webpack:///"}